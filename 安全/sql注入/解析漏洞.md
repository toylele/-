# 一、解析漏洞

## IIS

出现漏洞版本：ISS5.X-IIS6.X 	IIS7.5

利用方式：ISS5.X-IIS6.X **(/xx.asp/xx.jpg	xx.asp;.xx.jps 	test.asa test.cer test.cdx)**	IIS7.5**(a.aspx.a;.a.aspx.jpg..jpg)**

## Nginx

出现漏洞版本：Nginx<8.03 

利用方式：Nginx<8.03**空字节代码执行漏洞**	fix_pathinfo**(/1.jpg/1.php	/1.jpg%00.php	/1.jpg/%20\0.php)**

## Apache

出现漏洞版本：

利用方式：test.php.php123(从右到左开始判断解析)	AddHandler php5-script.php  test2.php.jpg	AddType application/x-httpd-php.jpg (即使扩展名为jpg一样以php进行执行)

# 二、文件包含漏洞

## 文件包含函数

PHP中文件包含函数有以下四种：

```shell
require() // 只在执行到此函数时才去包含文件，若包含的文件不存在产生警告，程序继续运行

require_once() // 如果一个文件已经被包含过，则不会在包含它

include() // 程序一运行文件便会包含进来，若包含文件不存在产生致命错误，程序终止运行

include_once() // 如果一个文件已经被包含过，则不会在包含它
```

```shell
样例：
<?php
/*本页面存在文件包含漏洞，用于测试图片马是否能正常运行!*/
header("Content-Type:text/html ; charset=utf-8");$file = $_GET['file’];
if(isset($file)) {
include$file;
}else {
show_source(__file_) ;
}
?>

```

## 文件包含漏洞分类

### 1. LFI(Local File Inclusion)

**本地文件包含漏洞**，指的是能打开并包含本地文件的漏洞。大部分情况下遇到的文件包含漏洞都是LFI。
为了方便本文把LFI直接称为文件包含漏洞。

### 2. RFI(Remote File Inclusion)

**远程文件包含漏洞**。是指能够包含远程服务器上的文件并执行。由于远程服务器的文件是我们可控的，因此漏洞一旦存在危害性会很大。但RFI的利用条件较为苛刻，需要php.ini中进行配置

需要满足两个条件在php.ini中。当php.ini 中的配置选项

```shell
allow_url_fopen: on
allow_url_include: on
```

> **通过php伪协议包含**

```shell
1、File:/l	--访问本地文件系统
2、http:/l	--访问http(s)网址
3、Phar:/l	--PHP归档
4、Php:/l	--访问各个输入/输出流
5、Zlib:/l	--压缩流
6、Data:/l	--数据


#File:/l	--访问本地文件系统
1、条件:
(1)allow_url_fopen: off/on 都可以
(2)allow_url_include:off/on都可以
2、作用:
用于访问本地文件系统，通常用于读取本地文件而且不会收到allow_url_fopen和allow_url_include的影响。
在include()/require()/include_once()/require_once()参数可控的情况下，如果导入非.php的文件，则仍按照php语法进行解析，因为这个是include()函数决定的。

#Php:/l	--访问各个输入/输出流
1、条件:
(1) allow_url_fopen:offlon都可以
(2) allow_url_include:仅php:/linput 、 php:/lstdin php://memory、php://temp需要on
2、作用:
Php://伪协议有很多的用法，常用的就是php:/filter用于读源码。Php://input用于执行php代码。

#data://协议包含∶
1、条件:
allow_url_fopen:on
allow_url_include :on
2、作用:
自PHP>=5.2.0起，可以使用data://数据流封装器，以传递相应格式的数据。通常可以用来执行PHP代码。
3、用法:
Data://text/plain,+（php命令）
Data://text/plain;base64,

#phar://协议包含:
phar://协议与zip:/类似，同样可以访问zip格式压缩包
1、条件:
allow_url_fopen:off/on都可以的
allow_url_inalude.;off/on都可以的
3、用法:
phar://绝对路径/压缩包内文件
```

![image-20241010135816296](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241010135816296.png)

 zip://*绝对路径*%23*压缩包内文件*

![image-20241011102714588](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241011102714588.png)

compress.zlib://*绝对路径*	可以解析使用不同压缩包后缀

![image-20241011103113228](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241011103113228.png)

高版本适用：phar://绝对路径/压缩包内文件

![image-20241011104224419](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241011104224419.png)

> 通过日志文件getshell包含

日志文件是用于记录系统操作事件的记录文件或文件集合，可分为事件日志和消息日志。具有处理历史数据、诊断问题的追踪以及理解系统的活动等重要作用。

> Session包含

Session就是保存在服务器的文本文件。默认情况下，PHP.ini中设置的
sEsSION保存方式是files (session.save_handler = files),即使用读写文件的方式保存SESSION数据，而SESSION文件保存的目录由session.save_path指定，文件名以sess_为前缀，后跟SESSION ID，如:sess_c72665af28a8b14c0fe11afe3b59b51b。文件中的数据即是序列化之后的sEsSION数据了

通过session包含的利用条件:

1、session文件路径已知
(1 ) session路径位置可以通过phpinfo页面来获取，
session.save_path为/var/lib/phplsession.

(2)通过猜测默认的session的存放位置进行尝试
Phpstudy默认session的存储路径为E:\phpStudy\PHPTutorialltmpltmp
2、且其中部分内容可控制
在默认的session的文件中，username后面的就是账号，那么能把这个账号控制变化那么就可以利用session包含。

```shell
#session群文件名，命名方式
sess_(id值)
```

![image-20241015134534232](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241015134534232.png)

![image-20241015134633010](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241015134633010.png)

### 3.绕过方式

一、实验目的：

1、通过本次学习掌握文件包含漏洞的绕过原理。
2、通过搭建漏洞环境，学习绕过技巧。

二、工具：

火狐/谷歌浏览器
burpsuite

三、实验环境：

靶   机： windows10虚拟机：192.168.100.150
      phpstudy2018_Apache集成环境

远端服务器： windows10虚拟机：192.168.100.151(相当于攻击者的公网服务器)

攻 击 机： windows10物理机

四、环境准备：

1. 营造环境：

1、在靶机主目录下创建一个test_include目录：

![image-20241015154226094](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241015154226094.png)
2、在靶机 test_include目录下创建一个index.php的文件：
代码内容：

<?php if(isset($_GET['page'])){

 include$_GET['page'].".php";}else{include'home.php'; }?>

![image-20241015154304222](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241015154304222.png)

3、在test_include目录下创建一个home.php：
代码内容：

<?php phpinfo();?>

![image-20241015154446720](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241015154446720.png)

4、在test_include目录下创建一个test.php:
代码内容:

<?phpecho "hello world";?>

![image-20241015154426351](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241015154426351.png)

5、测试代码执行：
直接访问目录，可以看出它是包含了home.php文件的：

![image-20241015154610252](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241015154610252.png)

传输一个test，可以看到它已经包含了test.php：
注：当我们使用GET方式传递一个文件名时，它会把后缀.php拼接上，如果存在这个文件，就成功包含，这样就显示文件内容了。

![image-20241015154623816](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241015154623816.png)
通过上面测试，说明代码可以正常执行，环境营造完成。

2. 设置phpstudy环境：

切换php版本：

![image-20241015154637523](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241015154637523.png)

关闭magic_quotes_gpc函数，并重启phpstudy：

![image-20241015154648369](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241015154648369.png)

五、实验过程：

1. 本地文件包含：

```shell
#常见的敏感信息路径：
Windows系统：
c:\boot.ini                                   // 查看系统版本
c:\windows\system32\inetsrv\MetaBase.xml      // IIS配置文件
c:\windows\repair\sam                         // 存储Windows系统初次安装的密码
c:\ProgramFiles\mysql\my.ini                  // MySQL配置
c:\ProgramFiles\mysql\data\mysql\user.MYD     // MySQL root密码
c:\windows\php.ini                            // php 配置信息

Linux/Unix系统：
/etc/passwd                                         // 账户信息
/etc/shadow                                         // 账户密码文件
/usr/local/app/apache2/conf/httpd.conf              // Apache2默认配置文件
/usr/local/app/apache2/conf/extra/httpd-vhost.conf  // 虚拟网站配置
/usr/local/app/php5/lib/php.ini                     // PHP相关配置
/etc/httpd/conf/httpd.conf                          // Apache配置文件
/etc/my.conf                                        // mysql 配置文件
```

1.1 %00截断绕过：

1.1.1 原理：

验证源码：

<?php if(isset($_GET['page'])){    //判断通过GET方式有没有获取到这个文件；

 include$_GET['page'].".php"; //通过page传递这个文件的名字，不包括文件后缀名；如果传递一个test，代码拼接.php，如果当前目录下存在test.php,就包含test.php;}else{include'home.php';       //否则就包含home.php}?>

 

校验过程：判断是否获取到这个文件-->通过GET方式传递一个文件名，并在文件名后面拼接.php后缀-->如果当前目录下有这个文件，就包含这个文件-->否则就包含home.php
注：
  在低版本中php读取文件名时认为%00是终止符，对于%00后面的内容就会失效。
  通过上面源码我们知道，通过GET方式传递的这个文件名是我们可以进行控制的，在这里我们可以通过%00截断后面拼接的内容，让后面拼接的内容失效。

1.1.2 实验步骤：

1、制作一个图片马放到test_include目录下，这里的内容不是一句话木马，是phpinfo();代码：
内容：

<?php phpinfo();?>

![image-20241015154744407](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241015154744407.png)
2、对1.png进行包含，报错没有这个文件：

![image-20241015154817134](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241015154817134.png)
3、包含1.png，使用burpsuite对这个文件进行抓包:

![image-20241015155034879](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241015155034879.png)
4、在1.png后面加上%00，进行00截断，可以看出，成功解析图片马：

![image-20241015155044905](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241015155044905.png)

1.2.1 原理：

Windows下目录最大长度为256字节，超出的部分会被丢弃；
Linux下目录最大长度为4096字节，超出的部分会被丢弃。

1.2.2 实验步骤：

利用方法：

http://192.168.100.150/test_include/index.php?page=1.png/./././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././/././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././/././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././/././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././/./././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././

1、包含1.png，使用burpsuite对这个文件进行抓包：

![image-20241015155059490](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241015155059490.png)
2、使用长路进行截断，使后面拼接的内容失效，可以看出，成功解析图片马：

![image-20241015155114273](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241015155114273.png)![image-20241015155126297](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241015155126297.png)

1.3 点号截断：

1.3.1 原理：

windows系统 点号 长于 256，超出的部分会被丢弃；
linux系统 点号 长于 4096，超出的部分会被丢弃；；

1.3.2 实验步骤：

利用方法：

http://192.168.100.150/test_include/index.php?page=1.png.................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................

1、包含1.png，使用burpsuite对这个文件进行抓包：

![image-20241015155145644](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241015155145644.png)

2、由于当前是windows环境，使用长于256个点号进行截断，使后面拼接的内容失效，可以看出，成功解析图片马：

![image-20241015155155728](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241015155155728.png)![image-20241015155217135](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241015155217135.png)

1.4 双写绕过：

  如果在文件包含是，服务器对我们传入的参数是通过函数把关键字符替换为空的情况下，我们可以通过对关键字符进行双写进行绕过。


1.5 大小写混合绕过：

如果在文件包含是，服务器对我们传入的参数没有进行严格过滤，比如没没有对大小写进行过滤，我们可以使用大小写混合进行绕过。


1.6 伪协议绕过：

PHP 带有很多内置 URL 风格的封装协议，可用于类似 fopen()、 copy()、 file_exists() 和 filesize() 的文件系统函数。 除了这些封装协议，还能通过 stream_wrapper_register() 来注册自定义的封装协议。

![image-20241015160007645](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241015160007645.png)

2. 远程文件包含：

  PHP的配置文件allow_url_fopen和allow_url_include设置为ON，include/require等包含函数可以加载远程文件，如果远程文件没经过严格的过滤，导致了执行恶意文件的代码，这就是远程文件包含漏洞。

allow_url_fopen = On（是否允许打开远程文件）
allow_url_include = On（是否允许include/require远程文件）

![image-20241015160454391](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241015160454391.png)

2.1 问号绕过：

1、在我们远端服务器网站主目录创建一个1.txt文件：
内容：

<?php phpinfo();?>

![image-20241015155245238](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241015155245238.png)

2、远程包含我们远端服务器的1.txt文件，可以看出，靶机把1.txt后面拼接了.php后缀：

![image-20241015155257161](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241015155257161.png)

3、远程包含远端服务器的1.txt，在1.txt后面添加一个？，可以看出靶机成功解析远端服务器的1.txt为php脚本文件:

![image-20241015155305487](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241015155305487.png)

2.2 #号绕过：

注：这里需要对#进行url编码，#的url编码为%23

![image-20241015155316097](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241015155316097.png)

2.3 %00截断绕过：

![image-20241015155326014](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241015155326014.png)

2.4 其他绕过方式：

一些常见的特殊字符URL编码：
![img](file:///C:\Users\admin\AppData\Local\Temp\ksohtml8000\wps27.jpg)

使用burpsuit对一些特殊字符跑一遍，看哪些字符可以：

![image-20241015155353043](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241015155353043.png)

![image-20241015155437093](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20241015155437093.png)







ffprobe -select_streams v:0 -show_frames -show_entries frame=pkt_pts_time,pict_type,key_frame -of csv ‪E:\Desktop\bee6e2a67175949a5c3f0106094fe10b.mp4
